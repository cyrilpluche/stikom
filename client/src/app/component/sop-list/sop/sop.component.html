<div class="container" *ngIf="!ready">
  <div class="row-first">
    <app-loader></app-loader>
  </div>
</div>

<div class="container" *ngIf="ready">

  <!-- SOP List back button -->
  <div class="row-first">
      <button type="button" class="btn btn-outline-danger waves-effect" routerLink="/sop-list"><h6 class="no-margin-bottom"><i class="fa fa-times mr-3"></i>Back</h6></button>
    <app-pdf-sop ></app-pdf-sop>
  </div>

  <!-- SOP Informations -->
  <div class="row-first">

    <!-- Error alert -->
    <div *ngIf="errorMessage && formNumber == 1" class="row justify-content-end error-text">
      <i>{{errorMessage}}</i>
    </div>

    <div class="card card-cascade hoverable">
        <div class="row card-body card-body-cascade">
          <a class="col-12 text-center " data-toggle="collapse" data-target="#sop" aria-expanded="false" aria-controls="sop">
            <ng-controller>STANDARD OPERATIONAL PROCEDURE - {{sop.sop_title.toUpperCase()}}</ng-controller>
          </a>

          <ng-controller class="col-12 collapse" id="sop">
            <div class="row text-center">
              <div class="col-12 center-block anil_nepal">
                <label class="switch switch-left-right">
                  <input class="switch-input" type="checkbox" [checked]="isEditable" (click)="makeEditable(1)">
                  <span class="switch-label" data-on="Editable" data-off="OFF"></span> <span class="switch-handle"></span> </label>
              </div>
            </div>

            <div class="row">
              <div class="col-3 font-weight-bold">
                <p>SOP number</p>
              </div>
              <div class="col-8">
                <input [disabled]="true" [(ngModel)]="sop.sop_id" type="text" class="form-control">
              </div>
            </div>

            <div class="row">
              <div class="col-3 font-weight-bold">
                <p>SOP title</p>
              </div>
              <div class="col-8">
                <input [disabled]="!isEditable" (keyup)="checkSop()" [(ngModel)]="sop.sop_title" type="text" class="form-control">
              </div>
            </div>

            <div class="row">
              <div class="col-3 font-weight-bold">
                <p>Creation date</p>
              </div>
              <div class="col-8">
                <input [disabled]="true" [(ngModel)]="sop.sop_creation" type="date" class="form-control">
              </div>
            </div>

            <div class="row">
              <div class="col-3 font-weight-bold">
                <p>Revision date</p>
              </div>
              <div class="col-8">
                <input [disabled]="true" [(ngModel)]="sop.sop_revision" type="date" class="form-control">
              </div>
            </div>

            <div class="row">
              <div class="col-3 font-weight-bold">
                <p>Published date</p>
              </div>
              <div class="col-8">
                <input [disabled]="!isEditable" [(ngModel)]="sop.sop_published" type="date" class="form-control">
              </div>
            </div>

            <div class="row">
              <div class="col-3 font-weight-bold">
                <p>Approved by</p>
              </div>
              <div class="col-8">
                <input [disabled]="true" [(ngModel)]="sop.sop_approvment" type="text" class="form-control">
              </div>
            </div>

            <div class="row">
              <div class="col-3 font-weight-bold">
                <p>Base Rule / Regulation</p>
              </div>
              <div class="col-8">
                <input [disabled]="!isEditable" [(ngModel)]="sop.sop_rules" type="text" class="form-control">
              </div>
            </div>

            <div class="row">
              <div class="col-3 font-weight-bold">
                <p>Staff qualifications</p>
              </div>
              <div class="col-8">
                <input [disabled]="!isEditable" [(ngModel)]="sop.sop_staff_qualification" type="text" class="form-control">
              </div>
            </div>

            <div class="row">
              <div class="col-3 font-weight-bold">
                <p>Supporting tools</p>
              </div>
              <div class="col-8">
                <input [disabled]="!isEditable" [(ngModel)]="sop.sop_tools" type="text" class="form-control">
              </div>
            </div>

            <div class="row">
              <div class="col-3 font-weight-bold">
                <p>Warning</p>
              </div>
              <div class="col-8">
                <input [disabled]="!isEditable" [(ngModel)]="sop.sop_warning" type="text" class="form-control">
              </div>
            </div>

            <div class="row">
              <div class="col-3 font-weight-bold">
                <p>Types of forms and reports</p>
              </div>
              <div class="col-8">
                <input [disabled]="!isEditable" [(ngModel)]="sop.sop_type_reports" type="text" class="form-control">
              </div>
            </div>

            <div class="row">
              <div class="col-3 font-weight-bold">
                <p>Objective</p>
              </div>
              <div class="col-8">
                <input [disabled]="!isEditable" (keyup)="checkSop()" [(ngModel)]="sop.sop_objectives" type="text" class="form-control">
              </div>
            </div>

            <div class="row row-first text-center">
              <div class="col">
                <button [disabled]="!isEditable || !isSopValid" class="btn btn-success waves-effect" type="button" data-toggle="modal" data-target="#confirmationModal">Save</button>
              </div>
            </div>
          </ng-controller>
        </div>
    </div>

  </div>


  <!-- UNITS -->
  <div class="row-first">

    <!-- Error alert -->
    <div *ngIf="errorMessage && formNumber == 2" class="row justify-content-end error-text">
      <i>{{errorMessage}}</i>
    </div>

    <div class="card card-cascade hoverable">
      <a>
        <div class="row card-body card-body-cascade text-center">
          <a class="col-12 text-center " data-toggle="collapse" data-target="#units" aria-expanded="false" aria-controls="units">
            <ng-controller class="col-12">UNITS</ng-controller>
          </a>

          <ng-controller class="col-12 collapse" id="units">
            <div class="row text-center">
              <div class="col-12 center-block anil_nepal">
                <label class="switch switch-left-right">
                  <input class="switch-input" type="checkbox" [checked]="isEditableUnits" (click)="makeEditable(2)">
                  <span class="switch-label" data-on="Editable" data-off="OFF"></span> <span class="switch-handle"></span> </label>
              </div>
            </div>

            <div *ngFor="let unit of units" class="row text-center">
                <div class="offset-2 col-8">
                  <input [disabled]="!isEditableUnits" (keyup)="checkUnits(unit)" [(ngModel)]="unit.unit_name" type="text" class="form-control">
                </div>
            </div>

            <div class="row row-first text-center">
              <div class="col">
                <button [disabled]="!isEditableUnits || !isUnitsValide" class="btn btn-success waves-effect" type="button" data-toggle="modal" data-target="#confirmationModal">Save</button>
              </div>
            </div>
          </ng-controller>
        </div>
      </a>
    </div>

  </div>

  <!-- ACTIVITIES -->
  <div class="row-first">

    <div class="card card-cascade hoverable">
        <div class="row card-body card-body-cascade justify-content-center">
          <a class="col-12 row" data-toggle="collapse" data-target="#activities" aria-expanded="false" aria-controls="activities">
            <ng-controller class="col-12 text-center">ACTIVITIES</ng-controller>
          </a>

          <ng-controller class="collapse col-12 row text-center justify-content-center" id="activities">

            <div class="col-12 row text-center">
              <div class="col-12 center-block anil_nepal">
                <label class="switch switch-left-right">
                  <input class="switch-input" type="checkbox" [checked]="isEditableActivities" (click)="makeEditable(3)">
                  <span class="switch-label" data-on="Editable" data-off="OFF"></span> <span class="switch-handle"></span> </label>
              </div>
            </div>

            <div *ngFor="let activity of convertMap(activities)" class="col-12 row justify-content-center">

              <hr class="col-12">

              <div class="col-1">
                <a *ngIf="isEditableActivities" (click)="pickActivity(activity, 1)" data-toggle="modal" data-target="#activityModal"><i class="fa fa-cog text-blue"></i></a>
              </div>
              <div class="col-1">({{activity['sub_activities'].length}})</div>
              <div class="col-8 text-left">{{activity['activity'].activity_title}}</div>
              <div class="col-2 text-center">
                <a *ngIf="activity['sub_activities'].length != 0">
                  <i class="fa fa-eye text-blue" data-toggle="collapse" [attr.data-target]="'#'+activity['activity'].activity_id" aria-expanded="false" aria-controls="{{activity['activity'].activity_id}}"></i>
                </a>
              </div>

              <!-- Collapsible element -->
              <ng-controller class="col-12 collapse" id="{{activity['activity'].activity_id}}">
                <div class="row" *ngFor="let sub_activity of activity['sub_activities']">
                  <div class="offset-1 col-1">
                    <a *ngIf="isEditableActivities" (click)="pickActivity(sub_activity, 2)" data-toggle="modal" data-target="#activityModal"><i class="fa fa-cog text-link"></i></a>
                  </div>
                  <div class="col-10 text-left">
                    {{sub_activity.activity_title}}
                  </div>
                </div>
              </ng-controller>
              <!-- / Collapsible element -->

            </div>

            <hr class="col-12">

            <div class="row row-first text-center">
              <div class="col">
                <button [disabled]="!isEditableActivities" class="btn btn-success waves-effect" type="button" data-toggle="modal" data-target="#confirmationModal">Save</button>
              </div>
            </div>
          </ng-controller>
        </div>
    </div>

  </div>

</div>

<!-- Modal confirmation -->
<app-confirmation title="Update SOP informations"
                  text="Are you sure you want to modify these informations ? If the SOP is used, this mights create some errors"
                  (success)="onSubmit(null)"
                  [isLinkActive]=false
                  link="sop-list">
</app-confirmation>

<app-activity-update *ngIf="activity_selected != null"
                     title={{title_modal_activity}}
                     [units]=units
                     (success)="onSubmit($event)"
                     [managment_levels]=management_levels
                     [activityUpdate]=activity_selected
                     [isLinkActive]=false>
</app-activity-update>
